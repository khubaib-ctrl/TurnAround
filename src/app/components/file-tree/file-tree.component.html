<div class="file-tree">
  <div class="tree-header">
    <h3>Files</h3>
    <button class="icon-btn-sm" (click)="loadTree()" title="Refresh">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M11.5 7a4.5 4.5 0 11-1.3-3.18" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        <path d="M11.5 2.5v1.5h-1.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  @if (loading()) {
    <div class="tree-loading">Loading files...</div>
  } @else if (error()) {
    <div class="tree-error">{{ error() }}</div>
  } @else if (tree()) {
    <div class="tree-content">
      <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: tree()!, depth: 0 }" />

      <ng-template #nodeTemplate let-node let-depth="depth">
        @if (node.is_dir) {
          <div class="tree-node dir-node" [style.padding-left.px]="depth * 16 + 8" (click)="toggleDir(node.path)">
            <span class="expand-icon" [class.expanded]="isExpanded(node.path)">
              <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                <path d="M3 2l4 3-4 3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="node-icon folder" [class.open]="isExpanded(node.path)">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                @if (isExpanded(node.path)) {
                  <path d="M1.5 3.5a1 1 0 011-1h3l1 1h4.5a1 1 0 011 1V5H2.5l-1-1.5zm0 2l1.2 5a1 1 0 001 .8h6.6a1 1 0 001-.8l1.2-5H1.5z" fill="currentColor"/>
                } @else {
                  <path d="M1.5 3.5a1 1 0 011-1h3l1 1h4.5a1 1 0 011 1v5.5a1 1 0 01-1 1h-8.5a1 1 0 01-1-1V3.5z" fill="currentColor"/>
                }
              </svg>
            </span>
            <span class="node-name">{{ node.name }}</span>
            @if (node.children) {
              <span class="dir-count">{{ node.children.length }}</span>
            }
          </div>
          @if (isExpanded(node.path) && node.children) {
            @for (child of node.children; track child.path) {
              <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: child, depth: depth + 1 }" />
            }
          }
        } @else {
          <div class="tree-node file-node" [style.padding-left.px]="depth * 16 + 8">
            <span class="expand-spacer"></span>
            <span class="node-icon" [attr.data-type]="getFileIcon(node)">
              @switch (getFileIcon(node)) {
                @case ('video') {
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <rect x="1" y="3" width="9" height="8" rx="1" stroke="currentColor" stroke-width="1.2"/>
                    <path d="M10 6l3-2v6l-3-2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                }
                @case ('audio') {
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M7 2v8M4 5v4M1 6v2M10 5v4M13 6v2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
                  </svg>
                }
                @case ('image') {
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <rect x="1.5" y="2" width="11" height="10" rx="1.5" stroke="currentColor" stroke-width="1.2"/>
                    <circle cx="4.5" cy="5.5" r="1.5" fill="currentColor"/>
                    <path d="M1.5 10l3-3 2 2 2-2 4 3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                }
                @case ('project') {
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <rect x="2" y="1" width="10" height="12" rx="1.5" stroke="currentColor" stroke-width="1.2"/>
                    <path d="M5 4h4M5 7h4M5 10h2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                  </svg>
                }
                @default {
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                    <path d="M3 1.5h5l3 3v8a1 1 0 01-1 1H3a1 1 0 01-1-1v-10a1 1 0 011-1z" stroke="currentColor" stroke-width="1.2"/>
                    <path d="M8 1.5v3h3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                  </svg>
                }
              }
            </span>
            <span class="node-name">{{ node.name }}</span>
            @if (node.size !== null) {
              <span class="file-size">{{ formatSize(node.size) }}</span>
            }
          </div>
        }
      </ng-template>
    </div>
  } @else {
    <div class="tree-empty">No project open</div>
  }
</div>
