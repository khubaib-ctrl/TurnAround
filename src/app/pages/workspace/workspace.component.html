<div class="workspace" [class.sidebar-collapsed]="sidebarCollapsed()">
  <!-- Toolbar -->
  <header class="toolbar">
    <div class="toolbar-left">
      <button class="icon-btn" (click)="toggleSidebar()" title="Toggle Sidebar">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <rect x="2" y="3" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <line x1="7" y1="3" x2="7" y2="15" stroke="currentColor" stroke-width="1.5"/>
        </svg>
      </button>
      <div class="project-name">{{ project()?.name || 'Turn Around' }}</div>
      <button
        class="resolve-link-btn"
        [class.linked]="linkedResolveName()"
        (click)="openResolvePicker()"
        [title]="linkedResolveName() ? 'Linked: ' + linkedResolveName() : 'Link DaVinci Resolve project'"
      >
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M5.5 8.5l3-3M4 9.5l-1.3 1.3a1.5 1.5 0 002.1 2.1L6.1 11.6M7.9 2.4l1.3-1.3a1.5 1.5 0 012.1 2.1L10 4.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
        @if (linkedResolveName()) {
          <span class="resolve-name">{{ linkedResolveName() }}</span>
        } @else {
          <span class="resolve-name">Link Resolve</span>
        }
      </button>
    </div>

    <div class="toolbar-center">
      <button class="btn-sm" (click)="openCommitDialog(false)">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="7" cy="7" r="2" fill="currentColor"/>
        </svg>
        Save Version
      </button>
      <app-milestone-button (milestone)="openCommitDialog(true)" />
      @if (history().length >= 2) {
        <button class="btn-sm btn-compare" (click)="enterCompareMode()">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M2 4h4M8 4h4M2 7h4M8 7h4M2 10h4M8 10h4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          </svg>
          Compare
        </button>
      }
    </div>

    <div class="toolbar-right">
      <button class="icon-btn" (click)="onBackToSetup()" title="Close Project">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M6 2H4a2 2 0 00-2 2v8a2 2 0 002 2h2M10.5 11.5L14 8l-3.5-3.5M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-layout">
    <div class="sidebar-container" [class.collapsed]="sidebarCollapsed()">
      <div class="sidebar-tabs">
        <button
          class="sidebar-tab"
          [class.active]="sidebarTab() === 'history'"
          (click)="sidebarTab.set('history')"
        >
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.3"/>
            <path d="M7 4v3l2 1.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          History
        </button>
        <button
          class="sidebar-tab"
          [class.active]="sidebarTab() === 'files'"
          (click)="sidebarTab.set('files')"
        >
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M1.5 3.5a1 1 0 011-1h3l1 1h4.5a1 1 0 011 1v5.5a1 1 0 01-1 1h-8.5a1 1 0 01-1-1V3.5z" stroke="currentColor" stroke-width="1.2"/>
          </svg>
          Files
        </button>
      </div>
      @if (sidebarTab() === 'history') {
        <app-ghost-sidebar class="sidebar-panel" />
      } @else {
        <app-file-tree class="sidebar-panel" />
      }
    </div>

    <main class="content-area">
      <app-ghost-timeline class="timeline-view" />
      <app-time-travel-slider class="slider-area" />
    </main>
  </div>

  <!-- Commit Dialog -->
  @if (showCommitDialog()) {
    <app-commit-dialog
      [isMilestone]="commitDialogMilestone()"
      [changedFiles]="changedFiles()"
      (committed)="onCommitCreated()"
      (closed)="onCommitDialogClose()"
    />
  }

  <!-- Resolve Picker Dialog -->
  @if (showResolvePicker()) {
    <div class="resolve-overlay" (click)="showResolvePicker.set(false)">
      <div class="resolve-dialog" (click)="$event.stopPropagation()">
        <h3>Link DaVinci Resolve Project</h3>
        <p class="resolve-dialog-hint">Select which Resolve project to track for automatic change detection.</p>
        @if (loadingResolve()) {
          <div class="resolve-dialog-hint">Scanning for Resolve projects...</div>
        } @else if (resolveProjects().length === 0) {
          <div class="resolve-dialog-hint">No DaVinci Resolve projects found on this system.</div>
        } @else {
          <select
            class="resolve-dialog-select"
            [value]="selectedResolveDb()"
            (change)="selectedResolveDb.set($any($event.target).value)"
          >
            <option value="">None (don't link)</option>
            @for (rp of resolveProjects(); track rp.db_path) {
              <option [value]="rp.db_path">{{ rp.name }}</option>
            }
          </select>
        }
        <div class="resolve-dialog-actions">
          <button class="resolve-btn-save" (click)="saveResolveLink()" [disabled]="loadingResolve()">Save</button>
          <button class="resolve-btn-cancel" (click)="showResolvePicker.set(false)">Cancel</button>
        </div>
      </div>
    </div>
  }
</div>
